name: Base

on:
  workflow_call:
    inputs:
      runner:
        required: false
        type: string
        default: ubuntu-latest

      command:
        required: true
        type: string

      profile:
        required: false
        type: string
        default: stable

      toolchain:
        required: false
        type: string
        default: ''

permissions:
  contents: read

defaults:
  run:
    shell: bash

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: '-Dwarnings'
  RUST_BACKTRACE: '1'
  RUST_STABLE: stable
  RUST_MSRV: '1.90.0'
  RUST_NIGHTLY: nightly-2026-01-01

jobs:
  run:
    runs-on: ${{ inputs.runner }}

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - id: resolve
        run: |
          tc="${{ inputs.toolchain }}"

          if [[ -z "${tc}" ]]; then
              case "${{ inputs.profile }}" in
                  stable)  tc="${RUST_STABLE}"  ;;
                  msrv)    tc="${RUST_MSRV}"    ;;
                  nightly) tc="${RUST_NIGHTLY}" ;;
                  *) echo "base: invalid profile '${{ inputs.profile }}'" >&2; exit 2 ;;
              esac
          fi

          echo "toolchain=${tc}" >> "${GITHUB_OUTPUT}"

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ steps.resolve.outputs.toolchain }}
          components: rust-src

      - uses: Swatinem/rust-cache@v2

      - name: Running bash ci
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

        run: bash ./scripts/run.sh ${{ inputs.command }}
